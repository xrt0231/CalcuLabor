<!DOCTYPE html>
<html lang="en">
    <head>
      <title>CalcuLabor</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="icon" href="/logo/logo_calculabor.png" type="image/x-icon">
      <link rel="stylesheet" href="/css/gantt.css" type="text/css"/>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
       <!-- Include the image-diff library -->
      <script src="/js/quagga.min.js"></script>
       <!-- Or use a CDN -->
      <!-- <script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script> -->
      <!--  jQuery -->
      <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

     

      <!--CDN moment js-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>

      <!--Sweet Alert2 CDN-->
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
     
    </head>
    <style>
      body {
        /* background-image: url("/logo/logo_calculabor.png"); */
        background-color: darkgray;
        margin: 0;
  }
    </style>
    <body>
      <nav class="navbar navbar-default">
       
        <div class="container-fluid">
          
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
           
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            
              <span class="sr-only">Toggle navigation   </span>
             
              <span class="icon-bar"> </span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              
            </button>
           
            <a href="/index.html"><img src="/logo/logo_calculabor.png" width="50px" height="50px"></a>
            
          </div>
      
          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            
            <ul class="nav navbar-nav">
              <!-- <li class="active"><a href="#">Link <span class="sr-only">(current)</span></a></li>
              <li><a href="#">Link</a></li> -->
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Manual<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/admin/standard.html">standard setting</a></li>  
                  <li><a href="/admin/schedule.html">Production planning</a></li>
                  <li><a href="/admin/production.html">Execute production</a></li>
                  <li><a href="/admin/hour.html">Working hour</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="/admin/dashboard.html">Dashboard</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="/index.html">Home</a></li>
                </ul>
              </li>
            </ul>
            
            <ul class="nav navbar-nav navbar-right">
              <li><a href="#">You are in producion planning......</a></li>
              <li>
                <a role="button" onclick="signout();">Sign out</a>
                <!-- <ul class="dropdown-menu">
                  <li><a href="#">Under construction</a></li>
                  <li><a href="#">-</a></li>
                  <li><a href="#">-</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="#">-</a></li>
                </ul> -->
              </li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>

      <div class="container-fluid">

      <div class="col-lg-6" style="height: 500px;">
        <div class="card mx-5">

          
          <div class="form-group col-md-6">
            <label>Production Process</label>
            <input type="text" class="form-control" list="recordProcessAuto" id="recordProcess"></input>
            <datalist id="recordProcessAuto"></datalist>
          </div>

          <div class="form-group col-md-6">
            <label>Production Order Number</label>
            <input type="text" class="form-control" list="MyInputAuto" id="MyInput">
            <datalist id="MyInputAuto"></datalist>
          </div>
          
        </div>

          <div class="form-group col-md-6">
            <label>Part Number</label>
            <input type="text" class="form-control" list="AutoPartNum" id="partNum"></input>
            <datalist id="AutoPartNum"></datalist>
          </div>
          <div class="form-group col-md-6">
            <label>Actual Output</label>
            <input type="text" class="form-control" id="outputQty">
          </div>

          <div class="form-group col-md-6">
            <label class="control-label" for="date">Start Date/Time</label>
            <div class='input-group date' >
              <input data-format="yyyy-MM-dd hh:mm:ss" type='text' id='start' value="" class="form-control"/>
              <span class="input-group-addon">
              <span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div>
           </div>
      
          <div class="form-group col-md-6">
            <label class="control-label" for="date">End Date/Time</label>
            <div class='input-group date' >
              <input data-format="yyyy-MM-dd hh:mm:ss" type='text' id='end' value="" class="form-control" />
              <span class="input-group-addon">
              <span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div>
          </div>


          <!-- <div class="bootstrap-iso">
            <div class="form-group col-md-6">
              <label class="control-label" for="date">Start Date</label>
              <input class="form-control" id="start" name="date" placeholder="MM/DD/YYY" type="text"/>
            </div>
          
            <div class="form-group col-md-6">
              <label class="control-label" for="date">End Date</label>
              <input class="form-control" id="end" name="date" placeholder="MM/DD/YYY" type="text"/>
            </div> -->
            <div class="form-group col-md-12">
              <button class="btn btn-primary btn-md" type="button" onclick="fetchData();"><img src="/logo/question-octagon.svg" alt="" width="25" height="20" title="Bootstrap"></button> 
              <button class="btn btn-primary btn-md" type="submit" onclick="fastCheckInOut();">Fast Check In/Out</button>
          </div>
          <div id="orderCreated"></div>
        </div>

      <!--Start and stop scanner-->   
      <div class="col-lg-6" style="height: 500px;">
        <div class="card mx-5"><br>
          <button class="btn btn-primary btn-md" id="btn" value="BC scanner"><img src="/logo/upc-scan.svg" alt="" width="25" height="20" title="Bootstrap">Turn on/off camera</button>
          <div id="scanner-container"></div>
        </div>
      </div>

      <div class="col-lg-6" style="height: 500px;">
        <div class="card mx-5">
          <button class="btn btn-primary btn-md" type="submit" onclick="fetchGanttChart();"><img src="/logo/bar-chart-steps.svg" alt="" width="25" height="20" title="Bootstrap"></button>
          <label for="output" style="font-size: 25px">Today's Production Result:</label> 
        </div>  
        <div class="col-lg-12" style="height: 500px;">
          <div class="form-group col-md-6">
            <label class="control-label" for="date">Start Date/Time</label>
            <div class='input-group date' >
              <input data-format="yyyy-MM-dd hh:mm:ss" type='text' id='start1' value="" class="form-control"/>
              <span class="input-group-addon">
              <span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div>
             
           </div>
      
          <div class="form-group col-md-6">
            <!-- <label class="control-label" for="date">End Date/Time</label>
            <div class='input-group date' >
              <input data-format="yyyy-MM-dd hh:mm:ss" type='text' id='end1' value="" class="form-control" />
              <span class="input-group-addon">
              <span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div> -->
          </div>
          <div class="form-group col-md-12"><div id="container">
            <div id="chart"></div>
        </div>
        
      </div>
      
      
        <script src="/js/camera.js"></script> 
        
        <script src="/js/gantt.js"></script>
        <!-- <script src="/js/initialize-gantt.js"></script> -->

        <script>
                //Check if user sign in status
                fetchUserData();
                
                //User sign out
                function signout(){
                                localStorage.removeItem("Authorization");
                                window.location.replace('/index.html');
                              }

              //Datetime picker function
              $(function() {
                $('#start').datetimepicker();
              });
                
              $(function() {
                $('#end').datetimepicker();
              });

              $(function() {
                $('#start1').datetimepicker();
              });
                
              $(function() {
                $('#end1').datetimepicker();
              });
              
              
              
              
              function fetchUserData (){
          
                  var token = localStorage.getItem('Authorization');
                  if(token){
                      let options = {
                            headers: { 
                              "Content-Type": "application/json"
                            },
                              method: "POST", 
                              body: JSON.stringify({
                              token:  token
                            })
                          };
                        
                          fetch('/api/1.0/admin/userProfile', options)
                            .then(response => {
                              let message = response.json();
                              console.log('fetching...');
                              return message;
                              })
                              .then(result => {
                
                                if (result.name==='notSignIn') {
                                  console.log('API fetch success...')
                                  console.log(result)
                                  Swal.fire('Please sign in...');
                                  setTimeout(function(){window.location.replace('/index.html')}, 3000);
                                  } else {}
                                });
                    }else {
                      Swal.fire('Please sign in...');
                      setTimeout(function(){window.location.replace('/index.html')}, 3000);
                    }
                  } 

              //Dropdown list of production process
              let dropdown = document.getElementById('recordProcessAuto');
                  const url = '/api/1.0/admin/dropdownProcess';

                  fetch(url)  
                    .then(  
                      function(response) {  
                        if (response.status !== 200) {  
                          console.warn('Looks like there was a problem. Status Code: ' + 
                            response.status);  
                          return;  
                        }

                        // Examine the text in the response  
                        response.json().then(function(data) {  
                          let option;
                      
                        for (let i = 0; i < data.length; i++) {
                          let option = document.createElement('option');
                           
                            option.value = data[i].record_process;
                            dropdown.appendChild(option);
                        }    
                        });  
                      }  
                    )  
                    .catch(function(err) {  
                      console.error('Fetch Error -', err);  
                    });

              //Dropdown list of production order number
              document.getElementById("recordProcess").addEventListener("input", function (){
                        let dropdown1 = document.getElementById('MyInputAuto');
                        let MyInput = document.getElementById('MyInput');
                        MyInput.value = "";
                        dropdown1.innerHTML = "";
                        
                        let process = document.getElementById('recordProcess').value;
                        const url1 = '/api/1.0/admin/dropdownProdOrdNum';
                    
                        let options = {
                            headers: {
                                "Content-Type": "application/json"
                                },
                            method: "POST",
                            body: JSON.stringify({
                                  process: process
                                })
                            
                          };  

                        fetch(url1, options)  
                          .then(  
                            function(response) {  
                              if (response.status !== 200) {  
                                console.warn('Looks like there was a problem. Status Code: ' + 
                                  response.status);  
                                return;  
                              }

                              // Examine the text in the response  
                              response.json().then(function(data) {  
                                let option;
                                
                                console.log('data fetched ... ...')
                              for (let i = 0; i < data.length; i++) {
                                let option = document.createElement('option');
                                
                                  option.value = data[i].production_order_num;
                                  dropdown1.appendChild(option);
                              }    
                              });  
                            }  
                          )  
                          .catch(function(err) {  
                            console.error('Fetch Error -', err);  
                          });
                  });      
                  //Dropdown list of part number
                  document.getElementById("MyInput").addEventListener("input", function (){
                        let dropdown2 = document.getElementById('AutoPartNum');
                        let MyInput = document.getElementById('partNum');
                        partNum.value = "";
                        dropdown2.innerHTML = "";
                        
                        let productionOrderNum = document.getElementById('MyInput').value;
                        const url1 = '/api/1.0/admin/dropdownPartNum';
                    
                        let options = {
                            headers: {
                                "Content-Type": "application/json"
                                },
                            method: "POST", 
                            body: JSON.stringify({
                              productionOrderNum: productionOrderNum
                                })
                            
                          };  

                        fetch(url1, options)  
                          .then(  
                            function(response) {  
                              if (response.status !== 200) {  
                                console.warn('Looks like there was a problem. Status Code: ' + 
                                  response.status);  
                                return;  
                              }

                              // Examine the text in the response  
                              response.json().then(function(data) {  
                                let option;
                                
                                console.log('data fetched ... ...')
                              for (let i = 0; i < data.length; i++) {
                                let option = document.createElement('option');
                                
                                  option.value = data[i].part_num;
                                  dropdown2.appendChild(option);
                              }    
                              });  
                            }  
                          )  
                          .catch(function(err) {  
                            console.error('Fetch Error -', err);  
                          });
                  });


              function fetchData (code){

                if(code){
                  var productionOrderNum =  code;
                  }else {var productionOrderNum = document.getElementById('MyInput').value;}

                // var recordProcess = document.getElementById('recordProcess').value;
                // var outputQty = document.getElementById('outputQty').value;
                // let today = new Date().toISOString().slice(0, 10);
                let options = {
                    headers: {
                        "Content-Type": "application/json"
                        },
                    method: "POST", 
                    body: JSON.stringify({
                        productionOrderNum:  productionOrderNum,
                        // recordProcess: recordProcess,
                        // outputQty:  outputQty,
                        // date: today
                        })
                    
                  };
                
                fetch('/api/1.0/admin/getProductionData', options)
                    .then(response => {
                        let message = response.json();
                        console.log('fetching...');
                        return message;
                        })
                    .then(result => {
                        if (result) {
                          console.log(result)
                          console.log('API fetch success...')
                          if(result[0].actual_start){
                            
                            if(result[0].actual_end){
                              let start = new Date(result[0].actual_start);
                              start = start.toLocaleDateString() + ' ' + start.toLocaleTimeString();
                              end = new Date(result[0].actual_end);
                              end = end.toLocaleDateString() + ' ' + end.toLocaleTimeString();
                              document.getElementById('MyInput').value = result[0].production_order_num;
                              document.getElementById('partNum').value = result[0].part_num;
                              document.getElementById('recordProcess').value = result[0].record_process;
                              document.getElementById('outputQty').value = result[0].actual_output;
                              const startValue = document.getElementById('start');
                              startValue.value = start;
                              const endValue = document.getElementById('end');
                              endValue.value = end;

                            }else{
                              let start = new Date(result[0].actual_start);
                              start = start.toLocaleDateString() + ' ' + start.toLocaleTimeString();
                              end = "";
                              
                              document.getElementById('MyInput').value = result[0].production_order_num;
                              document.getElementById('partNum').value = result[0].part_num;
                              document.getElementById('recordProcess').value = result[0].record_process;
                              document.getElementById('outputQty').value = result[0].actual_output;
                              const startValue = document.getElementById('start');
                              startValue.value = start;
                              const endValue = document.getElementById('end');
                              endValue.value = end;

                            }
                          
                          }else
                            {
                              start = "";
                              end = "";
                              
                              document.getElementById('MyInput').value = result[0].production_order_num;
                              document.getElementById('partNum').value = result[0].part_num;
                              document.getElementById('recordProcess').value = result[0].record_process;
                              document.getElementById('outputQty').value = result[0].actual_output;
                              const startValue = document.getElementById('start');
                              startValue.value = start;
                              const endValue = document.getElementById('end');
                              endValue.value = end;
                            }
                            
                            
                            // const startValue = document.getElementById('start');
                            // startValue.value = start;

                            // const endValue = document.getElementById('end');
                            // endValue.value = end;
                            
                            } else {
                              alert(result.msg);
                              }
                      });
                }
                
                // fetch production order infomation from DB to make gantt chart
                function fetchGanttChart() {
                  let chart = document.getElementById('chart');
                  chart.innerHTML = '';
                  let data = [];
                  let start = document.getElementById('start1').value;
                  // let end = document.getElementById('end1').value;
                    let options = {
                        headers: {
                            "Content-Type": "application/json"
                            },
                        method: "POST", 
                        body: JSON.stringify({
                          start: start,
                          // end: end
                            })
                        
                      };
                      
                    fetch('/api/1.0/admin/ganttchartActual', options)
                        .then(response => {
                            let message = response.json();
                            console.log('test');
                            return message;
                            })
                        .then(result => {
                            if (result) {
                                
                                console.log("API fetch success...");

                                //create gantt chart data
                                let ganttdata = {}
                                for (let i=0; i<result.length; i+=1){
                                    start = moment(result[i].actual_start).format("YYYY-MM-DD HH:mm:ss");
                                    end = moment(result[i].actual_end).format("YYYY-MM-DD HH:mm:ss");
                                    ganttdata = {
                                    recordID: i+1,
                                    row: `${result[i].record_process}`,
                                    tooltip: `PN: ${result[i].part_num}, PO#: ${result[i].production_order_num}, Start: ${start}, End: ${end}`,
                                    start: `${start}`,
                                    end: `${end}`,
                                  }
                                    data.push(ganttdata);
                                }
                                //An API call to grab data
                                function refreshFunction() { 
                                    
                                    return data;
                                    }
                              
                                    //Parameters that the chart expects
                                    let params = {
                                    sidebarHeader: "Unused right now",
                                    noDataFoundMessage: "No data found",
                                    startTimeAlias: "start",
                                    endTimeAlias: "end",
                                    idAlias: "recordID",
                                    rowAlias: "row",
                                    linkAlias: null,
                                    tooltipAlias: "tooltip",
                                    // groupBy: "groupId,subGroupId",
                                    // groupByAlias: "group,subGroup",
                                    refreshFunction: refreshFunction
                                    }
                              
                                    //Create the chart.
                                    //On first render the chart will call its refreshData function on its own.
                                    let ganttChart = new Gantt("chart", params);
                              
                                    //To refresh the chart's data
                                    ganttChart.refreshData();
                                                    
                                  } else {
                                    alert(result.msg);
                                    }
                              });
                    }

                    function fastCheckInOut() {

                      let productionOrderNum =  document.getElementById('MyInput');
                      // let recordProcess = document.getElementById('recordProcess');
                      // let start = document.getElementById('start');
                      // let end = document.getElementById('end');
                      let outputQty = document.getElementById('outputQty');

                      let options = {
                          headers: {
                              "Content-Type": "application/json"
                              },
                          method: "POST", 
                          body: JSON.stringify({
                              productionOrderNum: productionOrderNum.value,
                              // recordProcess: recordProcess.value,
                              // start: start.value,
                              // end: end.value,
                              outputQty: outputQty.value,
                              })
                        
                        };
                      productionOrderNum.value = '';
                      recordProcess.value = '';
                      start.value = '';
                      end.value = '';
                      outputQty.value = '';

                      fetch('/api/1.0/admin/fastCheckInOut', options)
                          .then(response => {
                              let message = response.json();
                              console.log('test');
                              return message;
                              })
                          .then(result => {
                            if(result){
                              console.log(result);
                                let productionOrderNum = result[0].production_order_num;
                                let recordProcess = result[0].recordProcess;
                                let startTime = new Date(result[0].actual_start);
                                let endTime = new Date(result[0].actual_end);
                                let =actualOutput = result[0].actual_output;
                                startTime = startTime.toLocaleDateString() +' '+ startTime.toLocaleTimeString();
                                endTime = endTime.toLocaleDateString() +' '+ endTime.toLocaleTimeString(); 
                              if (endTime) {
                                Swal.fire(`Production Order: ${productionOrderNum} @ Process ${recordProcess}, Actual start@: ${startTime} // Actual end@: ${endTime} Acutal output * ${actualOutput}`)
                                }else{
                                      Swal.fire(`Production Order: ${productionOrderNum} @ Process ${recordProcess}, Actual start@: ${startTime} // Actual end@: NA Acutal output * NA`)
                                      } 
                                    }else{
                                        alert(result.msg);
                                        }
                                });

                    }
        
        </script>

    </body>
</html>