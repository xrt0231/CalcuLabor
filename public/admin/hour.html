<!DOCTYPE html>
<html lang="en">
    <head>
      <title>CalcuLabor</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="/css/gantt.css" type="text/css"/>
      <link rel="icon" href="/logo/logo_calculabor.png" type="image/x-icon">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
       <!-- Include the image-diff library -->
      <script src="/js/quagga.min.js"></script>
       <!-- Or use a CDN -->
      <!-- <script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script> -->
      <!--  jQuery -->
      <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

      <!-- Isolated Version of Bootstrap, not needed if your site already uses Bootstrap -->
      <link rel="stylesheet" href="https://formden.com/static/cdn/bootstrap-iso.css" />

      <!-- Bootstrap Date-Picker Plugin -->
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>

      <!--Sweet Alert2 CDN-->
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    </head>
    <style>
      body {
        /* background-image: url("/logo/logo_calculabor.png"); */
        background-color: darkgray;
        margin: 0;
  }
    </style>
    
    <body>
      <nav class="navbar navbar-default">
       
        <div class="container-fluid">
          
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
           
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            
              <span class="sr-only">Toggle navigation</span>
             
              <span class="icon-bar"> </span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              
            </button>
           
            <a href="/index.html"><img src="/logo/logo_calculabor.png" width="50px" height="50px"></a>
            
          </div>
      
          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            
            <ul class="nav navbar-nav">
              <!-- <li class="active"><a href="#">Link <span class="sr-only">(current)</span></a></li>
              <li><a href="#">Link</a></li> -->
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Manual<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/admin/standard.html">standard setting</a></li>  
                  <li><a href="/admin/schedule.html">Production planning</a></li>
                  <li><a href="/admin/production.html">Execute production</a></li>
                  <li><a href="/admin/hour.html">Working hour</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="/admin/dashboard.html">Dashboard</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="/index.html">Home</a></li>
                </ul>
              </li>
            </ul>
            <!-- <form class="navbar-form navbar-left">
              <div class="form-group">
                <input type="text" class="form-control" placeholder="Search">
              </div>
              <button type="submit" class="btn btn-default">Submit</button>
              
            </form> -->
            
            <ul class="nav navbar-nav navbar-right">
              <li><a href="#">You are in working hour</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">User guide <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#">-</a></li>
                  <li><a href="#">-</a></li>
                  <li><a href="#">-</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="#">-</a></li>
                </ul>
              </li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
        
      </nav>
        
      <div class="container-fluid">

        <div class="col-lg-6" style="height: 500px;">
          <div class="card mx-5">
  
            <div class="form-group col-md-6">
              <label>Employee #</label>
              <input type="text" class="form-control" id="MyInput">
            </div>
  
            <div class="form-group col-md-6">
              <label>Process Name</label>
              <select type="text" class="form-control" id="recordProcess">
                <option ></option>
                <option >process_1</option>
                <option >process_2</option>
                <option >process_3</option>
                <option >process_4</option>
                <option >process_5</option>
                <option >process_6</option>
                <option >process_7</option>
                <option >process_8</option>
                <option >process_9</option>
                <option >process_10</option>
              </select>
            </div>
  
            <div class="bootstrap-iso">
              <div class="form-group col-md-6">
                <label class="control-label" for="date">Start Date/Time</label>
                <input class="form-control" id="start" name="date" placeholder="MM/DD/YYY" type="text"/>
              </div>
            <!-- Default input -->
              <div class="form-group col-md-6">
                <label class="control-label" for="date">End Date/Time</label>
                <input class="form-control" id="end" name="date" placeholder="MM/DD/YYY" type="text"/>
              </div>
              <div class="form-group col-md-12">
                <button class="btn btn-primary btn-md" type="button" onclick="fetchData();"><img src="/logo/question-octagon.svg" alt="" width="25" height="20" title="Bootstrap"></button> 
                <button class="btn btn-primary btn-md" type="submit" onclick="clockInOut();">Update</button>
                
              </div>
            </div>
          </div>
        </div>
         
        <!--Start and stop scanner-->
        <div class="col-lg-6" style="height: 500px;">
          <div class="card mx-5"><br>
            <button class="btn btn-primary btn-md" id="btn" value="BC scanner"><img src="/logo/upc-scan.svg" alt="" width="25" height="20" title="Bootstrap"> Turn on/off camera </button>
            <div id="scanner-container"></div>
            
          </div>
        </div>
  
        <div class="col-lg-6" style="height: 500px;">
          <div class="card mx-5">
            <button class="btn btn-primary btn-md" type="submit" onclick="fetchGanttChart();"><img src="/logo/bar-chart-steps.svg" alt="" width="25" height="20" title="Bootstrap"></button>
            <label for="output" style="font-size: 25px">Today's working hour plan:</label> 
            <div id="chart"></div>  
          </div>
        </div>
              
        <script src="/js/camera.js"></script>
        
        <script src="/js/gantt.js"></script>
        <!-- <script src="/js/initialize-gantt.js"></script> -->

        <script>

          //Chcekc if user signed in
          fetchUserData ()
          function fetchUserData (){
      
              var token = localStorage.getItem('Authorization');
              if(token){
                console.log(token);
                  let options = {
                        headers: { 
                          "Content-Type": "application/json"
                        },
                          method: "POST", 
                          body: JSON.stringify({
                          token:  token
                        })
                      };
                    
                      fetch('/api/1.0/admin/userProfile', options)
                        .then(response => {
                          let message = response.json();
                          console.log('fetching...');
                          return message;
                          })
                          .then(result => {
            
                            if (result.name==='notSignIn') {
                              console.log('API fetch success...')
                              console.log(result)
                              Swal.fire('Please sign in...');
                              setTimeout(function(){window.location.replace('/index.html')}, 3000);
                              } else {
                                
                                }
                            });
                }else {
                  Swal.fire('Please sign in...');
                  setTimeout(function(){window.location.replace('/index.html')}, 3000);
                }
              } 

          // fetch employee working hour infomation from DB
          function fetchData (code){
            if(code){
              var employeeId = code;

            } else {var employeeId =  document.getElementById('MyInput').value;}
            
            var recordProcess = document.getElementById('recordProcess').value;
            // var outputQty = document.getElementById('outputQty').value;
            // let today = new Date().toISOString().slice(0, 10);
            let options = {
                headers: {
                    "Content-Type": "application/json"
                     },
                method: "POST", 
                body: JSON.stringify({
                    employeeId: employeeId,
                    // productionOrderNum:  productionOrderNum,
                    recordProcess: recordProcess,
                    // outputQty:  outputQty,
                    // date: today
                    })
                
               };
            
            fetch('/api/1.0/admin/getHour', options)
                .then(response => {
                    let message = response.json();
                    console.log('fetching...');
                    return message;
                    })
                .then(result => {
                    if (result) {
                        console.log('API fetch success...')
                        let employeeId = result[0].employee_id;
                        let record_process = result[0].record_process;
                        var start = new Date(result[0].recentStart);
                        let end = new Date(result[0].recentEnd);
                        console.log(result[0].recentEnd);
                        if(result[0].recentEnd){
                          
                          
                          document.getElementById('MyInput').value = employeeId;
                          document.getElementById('start').value = start.toLocaleDateString() + ' ' + start.toLocaleTimeString();
                          document.getElementById('end').value = end.toLocaleDateString() + ' ' + end.toLocaleTimeString();
                        
                        }else{
                        
                              document.getElementById('MyInput').value = employeeId;
                              document.getElementById('start').value = start.toLocaleDateString() + ' ' + start.toLocaleTimeString();
                              // document.getElementById('end').value = end.toLocaleDateString() + ' ' + end.toLocaleTimeString();
                            }
                        } else {
                          alert(result.msg);
                          }
                   });
            }
            
            // fetch production order infomation from DB to make gantt chart
            
          
            // fetchGanttChart();
            
            function fetchGanttChart (){
              let data = [];
              var employeeId =  document.getElementById('MyInput').value;
              let today = new Date().toISOString().slice(0, 10);
              // var recordProcess = document.getElementById('recordProcess').value;

              let options = {
                  headers: {
                      "Content-Type": "application/json"
                      },
                  method: "POST", 
                  body: JSON.stringify({
                      date: today,
                      employeeId: employeeId,
                      })
                  
                };
                
              fetch('/api/1.0/admin/getHourChart', options)
                  .then(response => {
                      let message = response.json();
                      console.log('test');
                      return message;
                      })
                  .then(result => {
                      if (result) {
                          
                          console.log("API fetch success...");

                          //create gantt chart data
                          let workHourData = {}
                          for (let i=0; i<result.length; i+=1){
                            workHourData = {
                              recordID: i+1,
                              row: `${result[i].record_process}`,
                              tooltip: `${result[i].material_num}, ${result[i].record_process}, ${result[i].start}, ${result[i].end}`,
                              start: `${result[i].start}`,
                              end: `${result[i].end}`,
                             }
                              data.push(workHourData); 
                           }
                           //An API call to grab data
                          function refreshFunction() {
                              
                              return data;
                              }
                        
                              //Parameters that the chart expects
                              let params = {
                              sidebarHeader: "Unused right now",
                              noDataFoundMessage: "No data found",
                              startTimeAlias: "start",
                              endTimeAlias: "end",
                              idAlias: "recordID",
                              rowAlias: "row",
                              linkAlias: null,
                              tooltipAlias: "tooltip",
                              // groupBy: "groupId,subGroupId",
                              // groupByAlias: "group,subGroup",
                              refreshFunction: refreshFunction
                              }
                        
                              //Create the chart.
                              //On first render the chart will call its refreshData function on its own.
                              let ganttChart = new Gantt("chart", params);
                        
                              //To refresh the chart's data
                              ganttChart.refreshData();
                                              

                            } else {
                              alert(result.msg);
                              }
                        });
              }

              // fetch to clock in/out from DB
            function clockInOut (){

                var employeeId =  document.getElementById('MyInput');
                var recordProcess = document.getElementById('recordProcess');
                var start = document.getElementById('start');
                var end = document.getElementById('end');

                // let today = new Date().toISOString().slice(0, 10);
                let options = {
                    headers: {
                        "Content-Type": "application/json"
                        },
                    method: "POST", 
                    body: JSON.stringify({
                        employeeId: employeeId.value,
                        recordProcess: recordProcess.value,
                        start: start.value,
                        end: end.value,
                        // date: today
                        })
                    
                  };
                  
                  employeeId.value = '';
                  recordProcess.value = '';
                  start.value = '';
                  end.value = '';

                fetch('/api/1.0/admin/clockInOut', options)
                    .then(response => {
                        let message = response.json();
                        console.log('fetching...');
                        return message;
                        })
                    .then(result => {
                        if (result[0]) {
                            console.log(result[0]);
                            let employeeId = result[0].employee_id;
                            let record_process = result[0].record_process;
                            let start = new Date(result[0].recentStart);
                            let end = new Date(result[0].recentEnd);
                            
                            start = start.toLocaleDateString() +' '+ start.toLocaleTimeString();
                            end = end.toLocaleDateString() +' '+ end.toLocaleTimeString();
                            
                            if(result[0].recentEnd){
                              Swal.fire(`employee_ID: ${employeeId}, record_process: ${record_process}, clock in: ${start} // clock out: ${end}`)
                              }else{
                                Swal.fire(`employee_ID: ${employeeId}, record_process: ${record_process}, clock in: ${start} // clock out: NA`)
                              }
                          
                            } else {
                              alert(result.msg);
                              }
                      });
                }
</script>

    </body>
</html>