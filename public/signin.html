  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/logo/logo_calculabor.png" type="image/x-icon">
  <!--Boostrap-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/css/signupin.css">  
<!--JQuery CND--> 
  <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

  <!--Sweet Alert2 CDN-->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

  <!-- Sign in with apple -->
  <script type="text/javascript" src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>

  <!-- Sign in with Google -->
  
  <meta name="google-signin-client_id" content="813008326543-s88dl11p1j2meippp8vd4nrkb3jcpie3.apps.googleusercontent.com">

  <title>CalcuLabor</title>
</head>

<html>
<body>
	<!-- Main Content -->
	<div class="container-fluid">
		<div class="row main-content bg-success text-center">
			<div class="col-md-4 text-center company__info">
				<span class="company__logo"><h2><span class="fa fa-android"></span></h2></span>
				<h4 class="company_title"><a href="index.html"><img src="/logo/logo_calculabor.png"></a></h4>
			</div>
			<div class="col-md-8 col-xs-12 col-sm-12 login_form ">
				<div class="container-fluid">
					<div class="row">
						<h2>Sign In</h2>
					</div>
					<div class="row">
						<form control="" class="form-group">
							<div class="row">
								<input type="text" name="username" id="username" class="form__input" placeholder="Username" autocomplete="on">
							</div>
							<div class="row">
								<!-- <span class="fa fa-lock"></span> -->
								<input type="password" name="password" id="password" class="form__input" placeholder="Password" autocomplete="on">
								
								<!-- sign in with apple button -->
								<div style="display: flex; justify-content: center;" id="appleid-signin" data-color="black" data-border="true" data-type="sign in" data-height=35px data-width="375px" data-border-radius="60"></div>			
							    <br>
								<!-- sign in with google button -->
								<div style="display: flex; justify-content: center" id="my-signin2"></div>
								<a href="#" onclick="signOut();">Sign out</a>
							</div>		
							
							<!-- <div class="row">
								<input type="checkbox" name="remember_me" id="remember_me" class="">
								<label for="remember_me">Remember Me!</label>
							</div> -->
							<!-- <div class="row">
								<input type="submit" value="Submit" class="btn">
							</div> -->
						</form>
						<input type="submit" value="Submit" class="btn" onclick="fetchData()">
						
					</div>
					<div class="row">
						<p>Don't have an account? <a href="signup.html">Sign Up Here</a></p>
						
					</div>
					
				</div>
				
			</div>
		</div>
	</div>
	
	<!-- Footer -->
	<div class="container-fluid text-center footer">
	</div>

	<script>

		//Check google sign out if no authorization token existed

		function fetchData (){
			let username = document.getElementById('username').value;
			let password = document.getElementById('password').value;
			if(username){
			   if(password){
				 let options = {
							headers: {
							"Content-Type": "application/json"
							},
								method: "POST", 
								body: JSON.stringify({
								username:  username,
								password: password
							})
						};
					
						fetch('/api/1.0/admin/signIn', options)
							.then(response => {
								let message = response.json();
								console.log('fetching...');
								return message;
								})
								.then(result => {
								
										if (result.name === 'notInUserList') {
											Swal.fire('Please Sign Up');
											setTimeout(function(){window.location.replace('signup.html')}, 2500)
											console.log('API fetch success...')
											console.log(result)
											Swal.fire('Please sign up to become an authorized user')
										
										} else {
											window.location.replace('/index.html');
											localStorage.setItem('Authorization', 'Bearer ' + result[0].access_token);
											}
										})
									
				 }else {
						Swal.fire('Please input your password')
					   }		
			   }else {
					Swal.fire('Please input your username');
				   }
			}
	</script>

	<script type="text/javascript">
		
		AppleID.auth.init({
			clientId : 'lol.online.calculabor',
			scope : "name email",
			redirectURI : 'https://calculabor.online/api/1.0/apple/redirect',
			state : "",
			nonce : "",
			usePopup : true //or false defaults to false
		});

		console.log("redirect page----")
        
        if (typeof window !== "undefined") {
          console.log("window", window);
          document.addEventListener("AppleIDSignInOnSuccess", async data => {
            console.log("AppleIDSignInOnSuccess", data);

            try {
              const data = await AppleID.auth.signIn();
              console.log("data", data);

			  let options = {
				headers: {
					"Content-Type": "application/json"
				},
				method: "POST", 
				body: JSON.stringify({
					code: data.authorization.code,
				})
			  };	

			  fetch('/api/1.0/apple/verify', options)
			    .then(response => response.json())

			    .then(data => {
				console.log('Success:', data);
				window.location.replace('/index.html');
				localStorage.setItem('Authorization', 'Bearer ' + data[0].access_token);
				})	

				.catch((error) => {
				console.error('Error:', error);
				});

            } catch (error) {
              //handle error.
            }

          });
        //Listen for authorization failures
        document.addEventListener("AppleIDSignInOnFailure", error => {
        console.log("AppleIDSignInOnFailure", error);
        });
        }

		

		//sign in with google
		function onSuccess(googleUser) {
		  if(localStorage.getItem('Authorization') === "")
			{
			let options = {
					headers: {
						"Content-Type": "application/json"
					},
					method: "POST", 
					body: JSON.stringify({
						token: googleUser.getAuthResponse().id_token,
					})
				};	

				fetch('/api/1.0/google/verify', options)
					.then(response => response.json())

					.then(data => {
					console.log('Success:', data);
					window.location.replace('/index.html');
					localStorage.setItem('Authorization', 'Bearer ' + data[0].access_token);
					})	

					.catch((error) => {
					console.error('Error:', error);
					});

			}else{
				function signOut() {
					var auth2 = gapi.auth2.getAuthInstance();
					auth2.signOut().then(function () {
					console.log('User signed out.');
					});
        		}
			}
        }
		function onFailure(error) {
		console.log(error);
		}
		function renderButton() {
		gapi.signin2.render('my-signin2', {
			'scope': 'profile email',
			'width': 240,
			'height': 50,
			'longtitle': true,
			'theme': 'dark',
			'onsuccess': onSuccess,
			'onfailure': onFailure
		});
		}
	</script>
	<script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
</body>
</html>